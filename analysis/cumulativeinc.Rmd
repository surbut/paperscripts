---
title: "cumulativeinc"
author: "Your Name"
date: "2023-04-19"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,cache = FALSE,warning = FALSE,message = FALSE)

```


## Cumulative incidence plot
```{r,eval=T,echo=F,warning=FALSE,message=FALSE}
library(survival)
library(ggplot2)
library(dplyr)
library(survminer)

df = readRDS("output/amit_df.rds")
## make sure normalized
df$prs_quant = scale(df$SCORE)
df$prs.r = (rank(df$prs_quant) / length(df$prs_quant))
df$round_age = round(df$phenos.enrollment, 0)
df$ldl.quant = scale(df$ldladj)
df$sbp.quant = scale(df$sbp)
df$hdl.quant = scale(df$hdladj)
df$chol.quant = scale(df$choladj)
df$age.quant = scale(df$phenos.enrollment)
df$bmi.quant = scale(df$bmi)
df$phenos.has_CAD = df$has_disease
df$sex = ifelse(df$sex == "male", 1, 0)



df$enroll_age_cat=cut(df$phenos.enrollment,breaks = c(0,45,50,55,60,65,70,75))
df$censor_age_cat=cut(df$phenos.CAD_censor_age,breaks = c(0,45,50,55,60,65,70,75,80,85))

incidence_data <- df %>%
group_by(enroll_age_cat, censor_age_cat) %>%
summarize(cases = mean(phenos.has_CAD))%>%
  ungroup()

incidence_data <- incidence_data %>%
  group_by(enroll_age_cat) %>%
  mutate(cumulative_cases = cumsum(cases))

id=incidence_data



library(ggplot2)
ggplot(incidence_data, aes(x = censor_age_cat, y = cumulative_cases, color = enroll_age_cat,group=enroll_age_cat)) +geom_line() +
  stat_smooth()+
  xlab("Age of event") +
  ylab("Cumulative cases") +
  ggtitle("Cumulative incidence by age group")


###
df$pce=df$ascvdcat_all
df$enroll_age_cat=cut(df$phenos.enrollment,breaks = c(0,55,65,100))

fit <- survfit(Surv(phenos.CAD_censor_age, phenos.has_CAD)~enroll_age_cat, data=df[df$pce=="low",])

g_low=ggsurvplot(fit,
           conf.int = TRUE,
           ggtheme = theme_classic(base_size=15),fun = "cumhaz",xlim=c(40,100),xlab="Age",risk.table = T) 

###

fit <- survfit(Surv(phenos.CAD_censor_age, phenos.has_CAD)~enroll_age_cat, data=df[df$pce=="intermediate",])

g_int=ggsurvplot(fit,
           conf.int = TRUE,
           ggtheme = theme_classic(base_size=15),fun = "cumhaz",xlim=c(40,100),xlab="Age",risk.table = T) 

###


fit <- survfit(Surv(phenos.CAD_censor_age, phenos.has_CAD)~enroll_age_cat, data=df[df$pce=="high",])

g_high=ggsurvplot(fit,
           conf.int = TRUE,
           ggtheme = theme_classic(base_size=15),fun = "cumhaz",xlim=c(40,100),xlab="Age",risk.table = T) 
```

<!-- ## Here we plot the cumulative hazard for each risk category and stratify by age -->

<!-- ```{r,fig.height=8,fig.width=6} -->
<!-- g_low -->
<!-- ``` -->

<!-- ```{r,fig.height=8,fig.width=6} -->
<!-- g_int -->
<!-- ``` -->

<!-- ```{r,fig.height=8,fig.width=6} -->
<!-- g_high -->
<!-- ``` -->

# All age plots

-- Because we are using all individuals, Event time (age in years) is on the X axis, because time since enrollment would treat the 12 years from 50-62 as 70-82.
-- First we do for all and stratify by PRS category

```{r}


library(ggplot2)
library(gridExtra)

# Create 9 sample ggplots


fit <- survfit(Surv(phenos.CAD_censor_age, phenos.has_CAD) ~prscat, data=df)

g_prs= ggsurvplot(fit,
           pval = TRUE, conf.int = TRUE,
           #risk.table = TRUE, 
           #risk.table.col = "strata",
           fun="cumhaz",
           palette="nejm",
           xlim = c(40,80),
           xlab = "Time of Event (age in years)",
           ylab = "Cumulative Hazard",
          title = "Cumulative Hazard by PCE Category",
          legend.title = "PRS Category",
          legend.labs = c("PRS<20%", "PRS 20%-80%", "PRS>80%"))
          
         


```


```{r gallprs}
g_prs

plots <- list()

  plots[[1]] <- g_all
```

## Now we stratify by PCE category, again for all

```{r}

df$asccvd_cat_two=cut(df$)
fit <-
  survfit(Surv(phenos.CAD_censor_age, phenos.has_CAD) ~ ascvdcat_all,
          data = df)


g_pce = ggsurvplot(
  fit,
  conf.int = TRUE,
  #ggtheme = theme_classic(base_size =15),
  palette="nejm",
  xlim = c(40, 80),
  risk.table = F,
  pval = TRUE,
  #risk.table.col = "strata",
  fun = "cumhaz",
  xlab = "Time of Event (age in years)",
  ylab = "Cumulative Hazard",
  title = "Cumulative Hazard by PRS Category",
  legend.title = "10 year risk Category",
    legend.labs = c("10-yr risk <7.5%","10-yr risk 7.5-20%","10-yr risk 20%"))


```


```{r, gallpce}
g_pce
ggsave(g_pce,filename="Figs/gpce.tiff",dpi=300)

plots[[2]] <- g_pce
```

## Now we plot cumulative incidence by age of enrollment

```{r}
df$agecat=cut(df$enroll_age,breaks=c(0,55,65,100),labels=c("<55","55-65","65+"))

#fit <- survfit(Surv((phenos.CAD_censor_age-phenos.enrollment), phenos.has_CAD) ~agecat, data=df)

fit <- survfit(Surv((phenos.CAD_censor_age-phenos-phenos.enrollment), phenos.has_CAD) ~agecat, data=df)

genroll=ggsurvplot(fit, data = df,
           pval = TRUE, conf.int = TRUE,
           risk.table = F, 
           #risk.table.col = "strata",
           palette="nejm",
           fun="cumhaz",
           xlim = c(0, 15), 
           #xlim = c(40, 80),
           xlab = "Time since Enrollment",
           #xlab = "Time of Event (age in years)",
           ylab = "Cumulative Hazard",
           title = "Cumulative Hazard by Age Category since Enrollment",
            legend.title = "Age Category",
           legend.labs = c("Age <55", "Age 55-65", "Age >65"))
```

```{r genroll}
genroll


ga=ggarrange(g_prs$plot,g_pce$plot,genroll$plot,nrow=3,ncol=1,labels=c("A.","B.","C"))
plots[[3]] <- genroll

ggsave(ga,filename = "Figs/overlifecours.tiff",dpi = 300)
```


# Age cat specific plots

# Here we break into three age groups and stratify by PRS, asking about resolution by PRS:

```{r}
fit <- survfit(Surv((phenos.CAD_censor_age-phenos.enrollment), phenos.has_CAD) ~prscat, data=df[df$phenos.enrollment<55,])
# fit <- survfit(Surv((phenos.CAD_censor_age), phenos.has_CAD) ~prscat, data=df[df$phenos.enrollment<55,])
g_young=ggsurvplot(fit,
           pval = TRUE, conf.int = TRUE,
           ##risk.table = F, 
           ##risk.table.col = "strata",
           fun="cumhaz",
           xlim = c(0, 15), 
           #xlim = c(40, 80),
            xlab = "Time since Enrollment",
           #xlab = "Time of Event (Age)",
           ylab = "Cumulative Hazard",
           main = "Cumulative Hazard by PRS Category since Enrollment, Enrollment <55",
            legend.title = "PRS Category",
           legend.labs = c("PRS <20%", "PRS 20%-80%", "PRS >80%"))


fit <- survfit(Surv((phenos.CAD_censor_age-phenos.enrollment), phenos.has_CAD) ~prscat, data=df[df$phenos.enrollment>55&df$phenos.enrollment<65,])

# fit <- survfit(Surv((phenos.CAD_censor_age), phenos.has_CAD) ~prscat, data=df[df$phenos.enrollment>55&df$phenos.enrollment<65,])


g_mid=ggsurvplot(fit,
           pval = TRUE, conf.int = TRUE,
           #risk.table = TRUE, 
           #risk.table.col = "strata",
           fun="cumhaz",
           xlim = c(0, 15), 
           #xlim = c(40, 80),
           xlab = "Time since Enrollment",
           #xlab = "Time of Event (Age)",
           ylab = "Cumulative Hazard",
           main = "Cumulative Hazard by PRS Category since Enrollment, Enrollment 55-65",
            legend.title = "PRS Category",
           legend.labs = c("PRS <20%", "PRS 20%-80%", "PRS >80%"))


### 
fit <- survfit(Surv((phenos.CAD_censor_age-phenos.enrollment), phenos.has_CAD) ~prscat, data=df[df$phenos.enrollment>65,])

# fit <- survfit(Surv((phenos.CAD_censor_age), phenos.has_CAD) ~prscat, data=df[df$phenos.enrollment>65,])
g_old=ggsurvplot(fit,
           pval = TRUE, conf.int = TRUE,
           #risk.table = TRUE, 
           #risk.table.col = "strata",
           fun="cumhaz",
           xlim = c(0, 15), 
           #xlim = c(40, 80), 
           xlab = "Time since Enrollment",
           #xlab = "Time of Event (Age)",
           ylab = "Cumulative Hazard",
           main = "Cumulative Hazard by PRS Category since Enrollment, Enrollment >55",
            legend.title = "PRS Category",
           legend.labs = c("PRS <20%", "PRS 20%-80%", "PRS >80%"))
```

## <55

```{r gyoungprs}
g_young
plots[[4]]=g_young
```

## 55-65
```{r gmidprs}
g_mid
plots[[5]]=g_mid
```

## >65
```{r goldprs}
g_old
plots[[6]]=g_old
```


# Here we do the same for PCE:age normalized percentile

- here we standardize PCE distribution within each age to ~N(0,1)
- we look at bottom 20%, mid 20%, and top 20%
- I also do the same for nominal 10 year category with caveat that 10 year risk category is a low number in young folks

```{r}

dyoung=df[df$phenos.enrollment<55,]
dyoung$pce.age=scale(dyoung$ascvd_10y_accaha_all)
dyoung$pce.r=rank(dyoung$ascvd_10y_accaha_all)/length(dyoung$ascvd_10y_accaha_all)
dyoung$pce.cat=cut(dyoung$pce.r,breaks=c(0,0.20,0.80,1))
fit <- survfit(Surv((phenos.CAD_censor_age-phenos.enrollment), phenos.has_CAD) ~pce.cat, data=dyoung)

fit <- survfit(Surv(time = phenos.enrollment,time2 = phenos.CAD_censor_age, phenos.has_CAD) ~pce.cat, data=dyoung)

g_young=ggsurvplot(fit,
  #xlim = c(0,15),
  #xlim = c(40,80),
  risk.table = F,
  pval = TRUE,
  #risk.table.col = "strata",
  fun = "cumhaz",
  xlab = "Time since Enrollment",
  #xlab = "Time of Event (Age)",
  ylab = "Cumulative Hazard",
  #main = "Cumulative Hazard by PCE Category",
  legend.title = "Percentile Category",
  legend.labs = c("Age Rank 20%","Age Rank 20-80%","Age Rank >80%"))


###

dold=df[df$phenos.enrollment>55&df$phenos.enrollment<65,]
dold$pce.age=scale(dold$ascvd_10y_accaha_all)
dold$pce.r=rank(dold$pce.age)/length(dold$pce.age)
dold$pce.cat=cut(dold$pce.r,breaks=c(0,0.20,0.80,1))
fit <- survfit(Surv((phenos.CAD_censor_age-phenos.enrollment), phenos.has_CAD)~pce.cat, data=dold)


g_mid=ggsurvplot(fit,
  xlim = c(0,15),
  #xlim = c(40,80),
  risk.table = F,
  pval = TRUE,
  #risk.table.col = "strata",
  fun = "cumhaz",
  xlab = "Time since Enrollment",
  #xlab = "Time of Event (Age)",
  ylab = "Cumulative Hazard",
  #main = "Cumulative Hazard by PCE Category",
  legend.title = "Percentile Category",
    legend.labs = c("Age Rank 20%","Age Rank 20-80%","Age Rank >80%"))

####

dold=df[df$phenos.enrollment>65,]
dold$pce.age=scale(dold$ascvd_10y_accaha_all)
dold$pce.r=rank(dold$pce.age)/length(dold$pce.age)
dold$pce.cat=cut(dold$pce.r,breaks=c(0,0.20,0.80,1))
fit <- survfit(Surv((phenos.CAD_censor_age-phenos.enrollment), phenos.has_CAD) ~pce.cat, data=dold)

g_old=ggsurvplot(fit,
xlim = c(0,15),
#xlim = c(40,80),
  risk.table = F,
  pval = TRUE,
  #risk.table.col = "strata",
  fun = "cumhaz",
  xlab = "Time since Enrollment",
  #xlab = "Time of Event (Age)",
  ylab = "Cumulative Hazard",
  #main = "Cumulative Hazard by PCE Category",
  legend.title = "Percentile Category",
  legend.labs = c("Age Rank 20%","Age Rank 20-80%","Age Rank >80%"))


```

## <55

```{r gyoungpce}
g_young
plots[[7]]=g_young
```

## 55-65
```{r gmidpce}
g_mid
plots[[8]]=g_mid
```

## >65
```{r goldpce}
g_old
plots[[9]]=g_old
```


# Age specific with PCE category

```{r gyoungpcecatcode}

dyoung=df[df$phenos.enrollment<55,]
dyoung$pce.age=scale(dyoung$ascvd_10y_accaha_all)
dyoung$pce.r=rank(dyoung$pce.age)/length(dyoung$pce.age)
dyoung$pce.cat=cut(dyoung$pce.r,breaks=c(0,0.20,0.80,1))
fit <- survfit(Surv((phenos.CAD_censor_age-phenos.enrollment), phenos.has_CAD)~ascvdcat_all, data=dyoung)

g_young=ggsurvplot(fit,
  xlim = c(0,15),
  risk.table = F,
  pval = TRUE,
  #risk.table.col = "strata",
  fun = "cumhaz",
  xlab = "Time since Enrollment",
  ylab = "Cumulative Hazard",
  #main = "Cumulative Hazard by PCE Category",
  legend.title = "10 year risk Category",
legend.labs = c("10-yr risk <7.5%","10-yr risk 7.5-20%","10-yr risk >20%"))


###

dmid=df[df$phenos.enrollment>55&df$phenos.enrollment<65,]
dmid$pce.age=scale(dmid$ascvd_10y_accaha_all)
dmid$pce.r=rank(dmid$pce.age)/length(dmid$pce.age)
dmid$pce.cat=cut(dmid$pce.r,breaks=c(0,0.20,0.80,1))
fit <- survfit(Surv((phenos.CAD_censor_age-phenos.enrollment), phenos.has_CAD)~ascvdcat_all, data=dmid)


g_mid=ggsurvplot(fit,
  xlim = c(0,15),
  risk.table = F,
  pval = TRUE,
  #risk.table.col = "strata",
  fun = "cumhaz",
  xlab = "Time since Enrollment",
  ylab = "Cumulative Hazard",
  #main = "Cumulative Hazard by PCE Category",
  legend.title = "10 year risk Category",
    legend.labs = c("10-yr risk <7.5%","10-yr risk 7.5-20%","10-yr risk 20%"))

####

dold=df[df$phenos.enrollment>65,]
dold$pce.age=scale(dold$ascvd_10y_accaha_all)
dold$pce.r=rank(dold$pce.age)/length(dold$pce.age)
dold$pce.cat=cut(dold$pce.r,breaks=c(0,0.20,0.80,1))
fit <- survfit(Surv((phenos.CAD_censor_age-phenos.enrollment), phenos.has_CAD) ~ascvdcat_all, data=dold)

g_old=ggsurvplot(fit,
xlim = c(0,15),
  risk.table = F,
  pval = TRUE,
  #risk.table.col = "strata",
  fun = "cumhaz",
  xlab = "Time since Enrollment",
  ylab = "Cumulative Hazard",
  #main = "Cumulative Hazard by PCE Category",
  legend.title = "10 -year risk Category",
   legend.labs = c("10-yr risk <7.5%","10-yr risk 7.5-20%","10-yr risk >20%"))


```

## <55

```{r gyoungpcecat}
g_young
```

## 55-65
```{r gmidpcecat}
g_mid
```

## 65 +
```{r goldpcecat}
g_old
```


# HEre are the age percentiles of PCE risk:
```{r}
q=rbind(quantile(dyoung$ascvd_10y_accaha_all,probs = seq(0,1,by=0.10)),quantile(df$ascvd_10y_accaha_all[df$phenos.enrollment>55&df$phenos.enrollment<65],probs = seq(0,1,by=0.10)),quantile(df$ascvd_10y_accaha_all[df$phenos.enrollment>65],probs = seq(0,1,by=0.10)))

q=data.frame(t(q))
colnames(q)=c("<55","55-65","65+")
q$rank=seq(0,100,by=10)
qm=melt(q,id.vars = "rank")
barplot(q,beside = T)
q$age=c("<55","55-65",">65")

p=ggplot(qm,aes(x=rank,y=value,fill=variable,color=variable))+geom_bar(stat="identity",pos="dodge")+scale_fill_futurama()+theme_classic(base_size = 20)+labs(y="10-year Predicted ASCVD Risk",x="Age Rank",fill="Age Category")+guides(color="none")+geom_hline(yintercept = 7.5)

ggsave(p,filename = "output/ageascvddist.tiff",dpi=300)

```



# age of event by prs.rank

```{r}
a=df%>%group_by(round(prs.r,1))%>%summarise(mean=mean(phenos.CAD_censor_age[phenos.has_CAD==1]),sd=sd(phenos.CAD_censor_age[phenos.has_CAD==1]),n=sum(phenos.has_CAD==1))

a=data.frame(a)
colnames(a)=c("PRS.percentile","Age.of.Event","sd","n")
a$se=a$sd/sqrt(a$n)

a=a[-1,]

pprs<-ggplot(a, aes(x=PRS.percentile, y=Age.of.Event, fill=PRS.percentile,col=PRS.percentile)) + 
  geom_point()+
  geom_errorbar(aes(ymin=Age.of.Event-se, ymax=Age.of.Event+se),width=0.01,
                position=position_dodge(0.05))+ylim(50,71)+theme_classic()+stat_smooth()+ylab("Mean Age of Event")+xlab("Polygenic Risk Decile")
p=a
p$group=rep("PRS",length(a))

a=df%>%group_by(round(ascvd.r,1))%>%summarise(mean=mean(phenos.CAD_censor_age[phenos.has_CAD==1]),sd=sd(phenos.CAD_censor_age[phenos.has_CAD==1]),n=sum(phenos.has_CAD==1))

a=data.frame(a)
colnames(a)=c("PCE.percentile","Age.of.Event","sd","n")
a$se=a$sd/sqrt(a$n)
a$score=rep("PCE",length(a[,1]))
a$score=as.factor(a$score)

ppce<-ggplot(a, aes(x=PCE.percentile, y=Age.of.Event,group=score, fill=PCE.percentile,col=PCE.percentile)) + 
  geom_point()+
  geom_errorbar(aes(ymin=Age.of.Event-se, ymax=Age.of.Event+se), width=.02,
                position=position_dodge(0.05))+ylim(50,71)+theme_classic()+stat_smooth()+ylab("Mean Age of Event")+xlab("Pooled Cohort Equation Decile")+scale_color_continuous()

colnames(a)=colnames(p)=c("Decile","Age.of.Event","sd","n","se","Score")
r=rbind(p,a)



plot<-ggplot(r, aes(x=Decile, y=Age.of.Event,group=Score, fill=Score,col=Score)) + 
  geom_point()+
  geom_errorbar(aes(ymin=Age.of.Event-se, ymax=Age.of.Event+se), width=.02,
                position=position_dodge(0.05))+ylim(50,71)+theme_classic()+stat_smooth()+ylab("Mean Age of Event,years")+xlab("Decile")+scale_color_nejm()+scale_fill_nejm()+theme_classic(base_size = 15)

ggsave(plot,filename = "Figs/meanageofevent.tiff",dpi=300)
m=merge(p,a,by = "Decile")
write.csv(m,file = "Figs/Tables/meanageofevent.csv",quote = F,row.names = F)
# 
# gage=ggplot(a,aes(PRS.rank,Age.of.Event))+geom_point()+stat_smooth()+theme_classic()
# 
# a=df[df$phenos.has_CAD==1,]%>%group_by(round(phenos.CAD_censor_age,0))%>%summarise(mean(prs_quant))
# a=data.frame(a)
# colnames(a)=c("Age.of.Event","PRS.Quant")
# gprs=ggplot(a,aes(Age.of.Event,PRS.Quant))+geom_point()+stat_smooth()+theme_classic()
# 
# grid.arrange(gage,gprs,ncol=2)
# 
# 
# ggplot(aes(x = round(ascvd.r,1), y = phenos.CAD_censor_age,group=round(ascvd.r,1)), data = df[df$phenos.has_CAD==1,])) + geom_boxplot()+theme_classic()
# 
# ggplot(aes(x = round(prs_quant,0), y = phenos.CAD_censor_age,group=round(prs_quant,0)), data = df[df$phenos.has_CAD==1,]) + geom_boxplot()+theme_classic()+ylim(0,90)
# 
```

## interaction

# Here we break into three age groups and stratify by PRS, asking about resolution by PRS:

```{r}
dyoung=df[df$phenos.enrollment<55,]
dyoung$pce.age=scale(dyoung$ascvd_10y_accaha_all)
dyoung$pce.r=rank(dyoung$pce.age)/length(dyoung$pce.age)
dyoung$pce.cat=cut(dyoung$pce.r,breaks=c(0,0.20,0.80,1))
dyoung$Interaction=interaction(dyoung$prscat,dyoung$pce.cat)

fit <- survfit(Surv((phenos.CAD_censor_age-phenos.enrollment),phenos.has_CAD)~Interaction, data=dyoung)
# fit <- survfit(Surv((phenos.CAD_censor_age), phenos.has_CAD) ~prscat, data=df[df$phenos.enrollment<55,])
g_young=ggsurvplot(fit,
           pval = TRUE, conf.int = TRUE,
           ##risk.table = F, 
           ##risk.table.col = "strata",
           fun="cumhaz",
           xlim = c(0, 15), 
           #xlim = c(40, 80),
            xlab = "Time since Enrollment",
           #xlab = "Time of Event (Age)",
           ylab = "Cumulative Hazard",
           ylim=c(0,0.15),
           title = "Enrollment <55",
          legend.title = "PRS:PCE Rank",
          ggtheme = theme_classic2(base_size=12, base_family = "Arial"),
           font.family = "Arial",
          palette="jco",
          
          legend.labs = c("PRS low:PCE low", "PRS int:PCE low", "PRS high:PCE low",
                           "PRS low:PCE int", "PRS int:PCE int", "PRS high:PCE int",
                           "PRS low:PCE high", "PRS int:PCE high", "PRS high:PCE high"))

###

dmid=df[df$phenos.enrollment>55&df$phenos.enrollment<65,]
dmid$pce.age=scale(dmid$ascvd_10y_accaha_all)
dmid$pce.r=rank(dmid$pce.age)/length(dmid$pce.age)
dmid$pce.cat=cut(dmid$pce.r,breaks=c(0,0.20,0.80,1))
dmid$Interaction=interaction(dmid$prscat,dmid$pce.cat)

fit <- survfit(Surv((phenos.CAD_censor_age-phenos.enrollment),phenos.has_CAD)~Interaction, data=dmid)
# fit <- survfit(Surv((phenos.CAD_censor_age), phenos.has_CAD) ~prscat, data=df[df$phenos.enrollment<55,])
g_mid=ggsurvplot(fit,
           pval = TRUE, conf.int = TRUE,
           ##risk.table = F, 
           ##risk.table.col = "strata",
           fun="cumhaz",
           xlim = c(0, 15), 
           #xlim = c(40, 80),
            xlab = "Time since Enrollment",
           #xlab = "Time of Event (Age)",
           ylab = "Cumulative Hazard",
           ylim=c(0,0.15),
           title = "Enrollment 55-65",
          legend.title = "PRS:PCE Rank",
          ggtheme = theme_classic2(base_size=12, base_family = "Arial"),
           font.family = "Arial",
          palette="jco",
          
          legend.labs = c("PRS low:PCE low", "PRS int:PCE low", "PRS high:PCE low",
                           "PRS low:PCE int", "PRS int:PCE int", "PRS high:PCE int",
                           "PRS low:PCE high", "PRS int:PCE high", "PRS high:PCE high"))
###

dold=df[df$phenos.enrollment>65,]
dold$pce.age=scale(dold$ascvd_10y_accaha_all)
dold$pce.r=rank(dold$pce.age)/length(dold$pce.age)
dold$pce.cat=cut(dold$pce.r,breaks=c(0,0.20,0.80,1))
dold$Interaction=interaction(dold$prscat,dold$pce.cat)


fit <- survfit(Surv((phenos.CAD_censor_age-phenos.enrollment),phenos.has_CAD)~Interaction, data=dold)

# fit <- survfit(Surv((phenos.CAD_censor_age), phenos.has_CAD) ~prscat, data=df[df$phenos.enrollment>55&df$phenos.enrollment<65,])


g_old=ggsurvplot(fit,
           pval = TRUE, conf.int = TRUE,
           ##risk.table = F, 
           ##risk.table.col = "strata",
           fun="cumhaz",
           xlim = c(0, 15), 
           #xlim = c(40, 80),
            xlab = "Time since Enrollment",
           #xlab = "Time of Event (Age)",
           ylab = "Cumulative Hazard",
           ylim=c(0,0.15),
           title = "Enrollment >65",
          legend.title = "PRS:PCE Rank",
          ggtheme = theme_classic2(base_size=12, base_family = "Arial"),
           font.family = "Arial",
          palette="jco",
          
          legend.labs = c("PRS low:PCE low", "PRS int:PCE low", "PRS high:PCE low",
                           "PRS low:PCE int", "PRS int:PCE int", "PRS high:PCE int",
                           "PRS low:PCE high", "PRS int:PCE high", "PRS high:PCE high"))


```


## <55

```{r gyoungprs}
ggsave(g_young$plot,filename = "Figs/gyoung.tiff",dpi = 300,width = 10,height = 4)
write.csv(g_young$data.survtable,file = "Figs/Tables/cumulativeinc55.csv",quote = F,row.names = F)
ggplotly(g_young$plot)
ggplotly(g_young$plot)
```

## 55-65
```{r gmidprs}
g_mid
plots[[5]]=g_mid
ggsave(g_mid$plot,filename = "Figs/gmid.tiff",dpi = 300,width = 10,height = 4)
write.csv(g_mid$data.survtable,file = "Figs/Tables/cumulativeinc5565.csv",quote = F,row.names = F)
```

## >65
```{r goldprs}
g_old
plots[[6]]=g_old
ggsave(g_old$plot,filename = "Figs/gold.tiff",dpi = 300,width = 10,height = 4)
write.csv(g_old$data.survtable,file = "Figs/Tables/cumulativeinc65.csv",quote = F,row.names = F)

ggarrange(g_young$plot,g_mid$plot,g_old$plot,nrow=3,ncol=1,width=c(10,10,10),labels=c("A.","B.","C"),common.legend = T)
```

## return cumulative hazard for low and high of each age 

```{r}
get_cumI=function(ggsurvplot,stratum){
  stratum_data <- ggsurvplot$data.survplot[ggsurvplot$data.survplot$strata == stratum, ]
  cumulative_hazard <- -log(stratum_data$surv)
  return(cumulative_hazard[length(cumulative_hazard)])
}

get_cumI(g_young,stratum="Interaction=low.(0,0.2]")
get_cumI(g_young,stratum="Interaction=high.(0.8,1]")

get_cumI(g_mid,stratum="Interaction=low.(0,0.2]")
get_cumI(g_mid,stratum="Interaction=high.(0.8,1]")


get_cumI(g_old,stratum="Interaction=low.(0,0.2]")
get_cumI(g_old,stratum="Interaction=high.(0.8,1]")


